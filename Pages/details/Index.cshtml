@page "{id:int}"
@model DetailsModel
@{
    ViewData["Title"] = "Property Details";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<link rel="stylesheet" href="/css/site.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<link rel="stylesheet" href="/css/house1.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container">
    <!-- Fotoğraf Galerisi -->
    <div class="photo-gallery">
        <div class="gallery-main">
            <img src="~/media/houses/h_@Model.Property.propid/1.jpeg" alt="Ana Görsel">
        </div>
        <div class="gallery-thumbnails">
            <img src="~/media/houses/h_@Model.Property.propid/2.jpeg" alt="Küçük Görsel 1">
            <img src="~/media/houses/h_@Model.Property.propid/3.jpeg" alt="Küçük Görsel 2">
            <img src="~/media/houses/h_@Model.Property.propid/4.jpeg" alt="Küçük Görsel 3">
            <img src="~/media/houses/h_@Model.Property.propid/5.jpeg" alt="Küçük Görsel 4">
        </div>
    </div>

    <!-- Sol ve Sağ Paneller -->
    <div class="content-wrapper">
        <!-- Sol Panel -->
        <div class="left-panel">
            <!-- Bu mekan size neler sunuyor -->
            <div class="amenities-container">
                <h2>Bu mekan size neler sunuyor?</h2>
                <div class="amenities-grid">
                    <div class="amenity-item"><i class="fas fa-tree"></i> Bahçe manzarası</div>
                    <div class="amenity-item"><i class="fas fa-wifi"></i> Wifi</div>
                    <div class="amenity-item"><i class="fas fa-swimming-pool"></i> Havuz</div>
                    <div class="amenity-item"><i class="fas fa-car"></i> Ücretsiz otopark</div>
                </div>
                <button class="show-all-button">Tüm olanakları göster</button>
            </div>

            <!-- Takvim ve Harita -->
            <div class="calendar-map-container">
                <!-- Takvim -->
                <div class="calendar-container">
                    <h3>Rezervasyon Takvimi</h3>
                    <div id="calendar-range"></div>
                    <p>Toplam Gece: <span id="total-nights">0</span></p>
                    <p>Toplam Fiyat: <span id="total-price" data-price="1270">0</span> ₺</p>
                </div>
                <!-- Harita -->
                <div class="map-container">
                    <h3>Bu mekanın konumu</h3>
                    <div class="map-wrapper">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3011.5518644791823!2d28.829555111854166!3d40.99129277123343!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x14caa35ee1fdc1b1%3A0x658a212e6b4359b5!2zVC5DLiDEsHN0YW5idWwgS8O8bHTDvHIgw5xuaXZlcnNpdGVzaQ!5e0!3m2!1str!2str!4v1734778174512!5m2!1str!2str"
                                width="100%"
                                height="300"
                                style="border:0;"
                                allowfullscreen=""
                                loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sağ Panel -->
        <div class="right-panel">
            <div class="reservation-panel">
                <h3>@Model.Property.pricenight ₺ / gece</h3>
                <form method="get" action="/houses/reservation">
                    <label for="checkin">Giriş Tarihi</label>
                    <input type="text" id="checkin" name="checkin" placeholder="Giriş Tarihi" readonly />
                    <label for="checkout">Çıkış Tarihi</label>
                    <input type="text" id="checkout" name="checkout" placeholder="Çıkış Tarihi" readonly />
                    <label for="guests">Misafir Sayısı</label>
                    <select id="guests" name="guests">
                        @for (int i = 1; i <= Model.Property.guests; i++)
                        {
                            <option value="@i">@i misafir</option>
                        }
                    </select>
                    <button type="submit" class="reserve-btn">Rezerve Et</button>
                    <p class="note">Henüz sizden tahsilat yapılmayacak</p>
                    <div class="price-details">
                        <p><span id="total-nights">0</span> gece</p>
                        <p>Toplam: <span id="total-price">0</span> ₺</p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Yorumlar -->
    <div class="reviews-container">
        <h2>Yorumlar</h2>
        @if (HttpContext.Session.GetString("UserEmail") != null)
        {
            <form method="post">
                <label for="rating">Puan:</label>
                <input type="number" id="rating" name="Rating" min="1" max="5" step="0.1" required />
                <label for="comment">Yorum:</label>
                <textarea id="comment" name="Comment" placeholder="Yorumunuzu yazın..." required></textarea>
                <button type="submit" class="btn btn-primary">Yorum Yap</button>
            </form>
        }
        else
        {
            <p style="color:red;">Yorum yapabilmek için <a href="/home/login">giriş yapmalısınız</a>.</p>
        }

        @if (Model.Reviews != null && Model.Reviews.Any())
        {
            @foreach (var review in Model.Reviews.Take(3))
            {
                <div class="review">
                    <img src="/media/profile.jpg" alt="@review.User.Username" class="profile-pic">
                    <h4>@review.User.Username |⭐@review.rating</h4>
                    <p><strong>@review.CreatedAt.ToString("MMMM yyyy")</strong></p>
                    <p>@review.comment</p>
                </div>
            }
        }
        else
        {
            <p>Henüz değerlendirme yok.</p>
        }
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkinInput = document.querySelector("#checkin");
        const checkoutInput = document.querySelector("#checkout");
        const totalNightsDisplay = document.getElementById("total-nights");
        const totalPriceDisplay = document.getElementById("total-price");
        const pricePerNight = parseFloat(totalPriceDisplay.dataset.price);

        // Flatpickr Takvim Ayarı (Rezervasyon Takvimi)
        flatpickr("#calendar-range", {
            mode: "range",
            inline: true,
            dateFormat: "Y-m-d",
            minDate: "today",
            onChange: function (selectedDates) {
                if (selectedDates.length === 2) {
                    // Tarihleri yerel saat dilimine dönüştür
                    const checkinDate = new Date(
                        selectedDates[0].getFullYear(),
                        selectedDates[0].getMonth(),
                        selectedDates[0].getDate()
                    );
                    const checkoutDate = new Date(
                        selectedDates[1].getFullYear(),
                        selectedDates[1].getMonth(),
                        selectedDates[1].getDate()
                    );

                    const nights = (checkoutDate - checkinDate) / (1000 * 3600 * 24);

                    // Paneldeki Tarih Alanlarını Doldur
                    checkinInput.value = checkinDate.toISOString().split("T")[0];
                    checkoutInput.value = checkoutDate.toISOString().split("T")[0];

                    // Toplam Gece ve Fiyat Hesaplama
                    totalNightsDisplay.innerText = nights > 0 ? nights : 0;
                    totalPriceDisplay.innerText = nights > 0
                        ? (nights * pricePerNight).toLocaleString()
                        : 0;
                }
            },
        });

        // Paneldeki tarih alanlarının tıklanmasını engelle
        checkinInput.addEventListener("focus", function (event) {
            event.preventDefault();
            checkinInput.blur();
        });

        checkoutInput.addEventListener("focus", function (event) {
            event.preventDefault();
            checkoutInput.blur();
        });
    });
</script>
